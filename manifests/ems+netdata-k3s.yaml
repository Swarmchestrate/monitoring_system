# Source: netdata/templates/serviceaccount.yaml
kind: ServiceAccount
apiVersion: v1
metadata:
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
  name: netdata
  namespace: default
---
# Source: netdata/templates/child/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: netdata-conf-child
  namespace: default
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
data:

  go.d: |
    modules:
      pulsar: no
      prometheus: yes
  kubelet: |
    update_every: 1
    autodetection_retry: 0
    jobs:
      - name: local
        url: http://127.0.0.1:10255/metrics
      - name: local
        url: https://localhost:10250/metrics
        tls_skip_verify: yes
  kubeproxy: |
    update_every: 1
    autodetection_retry: 0
    jobs:
      - name: local
        url: http://127.0.0.1:10249/metrics
  netdata: |
    [db]
      mode = ram
    [web]
      bind to = localhost:19999
    [health]
      enabled = no
    [ml]
      enabled = no
  stream: |
    [stream]
      enabled = yes
      destination = netdata:19999
      api key = 11111111-2222-3333-4444-555555555555
      timeout seconds = 60
      buffer size bytes = 1048576
      reconnect delay seconds = 5
      initial clock resync iterations = 60
---
# Source: netdata/templates/child/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: netdata-child-sd-config-map
  namespace: default
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
data:
  config.yml: |
    disabled: no
    
    name: 'kubernetes'
    
    discover:
      - discoverer: k8s
        k8s:
          - tags: unknown
            role: pod
            pod:
              local_mode: yes
    classify:
      - name: "Control-Plane"
        selector: unknown
        tags: -unknown control_plane
        match:
          - tags: kube_scheduler
            expr: '{{ glob .Image "k8s.gcr.io/kube-scheduler:*" }}'
          - tags: kube_controller_manager
            expr: '{{ glob .Image "k8s.gcr.io/kube-controller-manager:*" }}'
      - name: "Applications"
        selector: unknown
        tags: -unknown applications
        match:
          - tags: activemq
            expr: '{{ and (eq .Port "8161") (glob .Image "*/activemq*") }}'
          - tags: apache
            expr: '{{ and (eq .Port "80" "8080") (glob .Image "httpd*" "*/httpd*") }}'
          - tags: bind
            expr: '{{ and (eq .Port "8653") (glob .Image "*/bind*") }}'
          - tags: cockroachdb
            expr: '{{ and (eq .Port "8080") (glob .Image "*/cockroach*") }}'
          - tags: consul
            expr: '{{ and (eq .Port "8500") (glob .Image "consul*" "*/consul*") }}'
          - tags: coredns
            expr: '{{ and (eq .Port "9153") (glob .Image "*/coredns*") }}'
          - tags: elasticsearch
            expr: '{{ and (eq .Port "9200") (glob .Image "elasticsearch:*" "*/elasticsearch:*") }}'
          - tags: fluentd
            expr: '{{ and (eq .Port "24220") (glob .Image "fluentd*" "*/fluentd*") }}'
          - tags: freeradius
            expr: '{{ and (eq .Port "18121") (glob .Image "*/freeradius*") }}'
          - tags: hdfs
            expr: '{{ and (eq .Port "50070") (glob .Image "*/hdfs*") }}'
          - tags: lighttpd
            expr: '{{ and (eq .Port "80" "8080") (glob .Image "*/lighttpd*") }}'
          - tags: logstash
            expr: '{{ and (eq .Port "9600") (glob .Image "logstash*" "*/logstash*") }}'
          - tags: mysql
            expr: '{{ and (eq .Port "3306") (glob .Image "mysql*" "*/mysql*" "mariadb*" "*/mariadb*") }}'
          - tags: nginx
            expr: '{{ and (eq .Port "80" "8080") (glob .Image "nginx*" "*/nginx*") }}'
          - tags: openvpn
            expr: '{{ and (eq .Port "7505") (glob .Image "*/openvpn") }}'
          - tags: phpfpm
            expr: '{{ and (eq .Port "80" "8080") (glob .Image "*/phpfpm*" "*/php-fpm*") }}'
          - tags: rabbitmq
            expr: '{{ and (eq .Port "15672") (glob .Image "rabbitmq*" "*/rabbitmq*") }}'
          - tags: solr
            expr: '{{ and (eq .Port "8983") (glob .Image "solr*" "*/solr*") }}'
          - tags: tengine
            expr: '{{ and (eq .Port "80" "8080") (glob .Image "*/tengine*") }}'
          - tags: unbound
            expr: '{{ and (eq .Port "8953") (glob .Image "*/unbound*") }}'
          - tags: vernemq
            expr: '{{ and (eq .Port "8888") (glob .Image "*/vernemq*") }}'
          - tags: zookeeper
            expr: '{{ and (eq .Port "2181") (glob .Image "zookeeper*" "*/zookeeper*") }}'
          - tags: consul_envoy
            expr: |
              {{ $imageOK := glob .Image "*/consul-dataplane*" -}}
              {{ $scrapeOK := eq (get .Annotations "prometheus.io/scrape") "true" -}}
              {{ $promPort := get .Annotations "prometheus.io/port" -}}
              {{ $portOK1 := and (eq .Port $promPort) (not (empty .Port)) -}}
              {{ $portOK2 := and (empty .Port) (not (empty $promPort)) -}}
              {{ and $imageOK $scrapeOK (or $portOK1 $portOK2) }}
      - name: "Prometheus Generic Applications"
        selector: unknown
        tags: -unknown prometheus_generic
        match:
          - tags: prometheus_generic
            expr: |
              {{ $scrapeOK := eq (get .Annotations "prometheus.io/scrape") "true" -}}
              {{ $portOK := eq (default .Port (get .Annotations "prometheus.io/port")) .Port -}}
              {{ $imageOK := not (glob .Image "netdata/netdata*" "*pulsar*" "*telegraf*") -}}
              {{ and $scrapeOK $portOK $imageOK }}
    compose:
      - name: "Control-Plane"
        selector: '!unknown control_plane'
        config:
          - selector: kube_scheduler
            template: |
              - module: prometheus
                name: prometheus-{{.TUID}}
                url: http://{{.PodIP}}:{{default "10251" .Port}}/metrics
                app: '{{.ContName}}'
                update_every: 10
                max_time_series: 1000
          - selector: kube_controller_manager
            template: |
              - module: prometheus
                name: prometheus-{{.TUID}}
                url: http://{{.PodIP}}:{{default "10252" .Port}}/metrics
                app: '{{.ContName}}'
                update_every: 10
                max_time_series: 2000
      - name: "Prometheus Generic Applications"
        selector: '!unknown prometheus_generic'
        config:
          - selector: prometheus_generic
            template: |
              {{ $path := default "/metrics" (get .Annotations "prometheus.io/path") -}}
              - module: prometheus
                name: prometheus-{{.TUID}}
                url: http://{{.Address}}{{$path}}
                app: '{{.ContName}}'
                update_every: 10
                max_time_series: 4000
      - name: "Applications"
        selector: '!unknown applications'
        tags: file
        config:
          - selector: activemq
            template: |
              - module: activemq
                name: activemq-{{.TUID}}
                url: http://{{.Address}}
          - selector: apache
            template: |
              - module: apache
                name: apache-{{.TUID}}
                url: http://{{.Address}}/server-status?auto
          - selector: bind
            template: |
              - module: bind
                name: bind-{{.TUID}}
                url: http://{{.Address}}/json/v1
          - selector: cockroachdb
            template: |
              - module: cockroachdb
                name: cockroachdb-{{.TUID}}
                url: http://{{.Address}}/_status/vars
          - selector: consul
            template: |
              - module: consul
                name: consul-{{.TUID}}
                url: http://{{.Address}}
          - selector: coredns
            template: |
              - module: coredns
                name: coredns-{{.TUID}}
                url: http://{{.Address}}/metrics
          - selector: elasticsearch
            template: |
              - module: elasticsearch
                name: elasticsearch-{{.TUID}}
                url: http://{{.Address}}
          - selector: consul_envoy
            template: |
              {{ $path := default "/metrics" (get .Annotations "prometheus.io/path") -}}
              {{ $promPort := get .Annotations "prometheus.io/port" -}}
              {{ $port := ternary .Port $promPort (not (empty .Port)) -}}
              - module: envoy
                name: {{.TUID}}
                url: http://{{ .PodIP }}:{{ $port }}{{ $path }}
          - selector: fluentd
            template: |
              - module: fluentd
                name: fluentd-{{.TUID}}
                url: http://{{.Address}}
          - selector: freeradius
            template: |
              - module: freeradius
                name: freeradius-{{.TUID}}
                address: {{.PodIP}}
                port: {{.Port}}
          - selector: hdfs
            template: |
              - module: hdfs
                name: hdfs-{{.TUID}}
                url: http://{{.Address}}/jmx
          - selector: lighttpd
            template: |
              - module: lighttpd
                name: lighttpd-{{.TUID}}
                url: http://{{.Address}}/server-status?auto
          - selector: logstash
            template: |
              - module: logstash
                name: logstash-{{.TUID}}
                url: http://{{.Address}}
          - selector: mysql
            template: |
              - module: mysql
                name: mysql-{{.TUID}}
                dsn: 'netdata@tcp({{.Address}})/'
          - selector: nginx
            template: |
              - module: nginx
                name: nginx-{{.TUID}}
                url: http://{{.Address}}/stub_status
          - selector: openvpn
            template: |
              - module: openvpn
                name: openvpn-{{.TUID}}
                address: {{.Address}}
          - selector: phpfpm
            template: |
              - module: phpfpm
                name: phpfpm-{{.TUID}}
                url: http://{{.Address}}/status?full&json
          - selector: rabbitmq
            template: |
              - module: rabbitmq
                name: rabbitmq-{{.TUID}}
                url: http://{{.Address}}
          - selector: solr
            template: |
              - module: solr
                name: solr-{{.TUID}}
                url: http://{{.Address}}
          - selector: tengine
            template: |
              - module: tengine
                name: tengine-{{.TUID}}
                url: http://{{.Address}}/us
          - selector: unbound
            template: |
              - module: unbound
                name: unbound-{{.TUID}}
                address: {{.Address}}
                use_tls: false
          - selector: vernemq
            template: |
              - module: vernemq
                name: vernemq-{{.TUID}}
                url: http://{{.Address}}/metrics
          - selector: zookeeper
            template: |
              - module: zookeeper
                name: zookeeper-{{.TUID}}
                address: {{.Address}}
---
# Source: netdata/templates/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: netdata
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
rules:
  - apiGroups: [""]
    resources:
      - "pods"           # used by sd, go.d/k8s_state, netdata (cgroup-name.sh, get-kubernetes-labels.sh)
      - "services"       # used by sd
      - "configmaps"     # used by sd
      - "secrets"        # used by sd
      - "nodes"          # used by go.d/k8s_state
      - "nodes/metrics"  # used by go.d/k8s_kubelet when querying Kubelet HTTPS endpoint
      - "nodes/proxy"    # used by netdata (cgroup-name.sh) when querying Kubelet /pods endpoint
    verbs:
      - "get"
      - "list"
      - "watch"
  - apiGroups: ["apps"]
    resources:
      - "deployments"
    verbs:
      - "get"
      - "list"
      - "watch"
  - apiGroups: ["batch"]
    resources:
      - "cronjobs"
      - "jobs"
    verbs:
      - "get"
      - "list"
      - "watch"
  - apiGroups: [""]
    resources:
      - "namespaces"  # used by go.d/k8s_state, netdata (cgroup-name.sh, get-kubernetes-labels.sh)
    verbs:
      - "get"
---
# Source: netdata/templates/clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: netdata
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: netdata
subjects:
  - kind: ServiceAccount
    name: netdata
    namespace: default
---
# Source: netdata/templates/child/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: netdata-child
  namespace: default
  labels:
    app: netdata
    chart: netdata-3.7.146
    release: netdata
    heritage: Helm
    role: child
spec:
  selector:
    matchLabels:
      app: netdata
      release: netdata
      role: child
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/netdata: unconfined
        checksum/config: bfb7bdcd0f5c1518a93bb509582b40919ca054cfd5a56a0cbd4f1425163b45d2
      labels:
        app: netdata
        release: netdata
        role: child
    spec:
      serviceAccountName: netdata
      restartPolicy: Always
      hostPID: true
      hostIPC: true
      hostNetwork: true
      initContainers:
        - name: init-persistence
          image: "alpine:latest"
          resources:
            requests:
              cpu: 10m
          imagePullPolicy: Always
          volumeMounts:
            - name: persistencevarlibdir
              mountPath: "/persistencevarlibdir"
          command:
            - "/bin/sh"
          args:
            - "-c"
            - '
            chmod 777 /persistencevarlibdir;
            '
      containers:
        - name: netdata
          image: "netdata/netdata:v2.6.3"
          imagePullPolicy: Always
          env:
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: MY_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NETDATA_LISTENER_PORT
              value: '19999'
          ports:
            - name: http
              containerPort: 19999
              protocol: TCP
          livenessProbe:
            exec:
              command:
                - /usr/sbin/netdatacli
                - ping
            initialDelaySeconds: 0
            failureThreshold: 3
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 1
          readinessProbe:
            exec:
              command:
                - /usr/sbin/netdatacli
                - ping
            initialDelaySeconds: 0
            failureThreshold: 3
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 1
          volumeMounts:
            - name: proc
              readOnly: true
              mountPath: /host/proc
            - name: sys
              mountPath: /host/sys
            - name: os-release
              mountPath: /host/etc/os-release
            - name: varlog
              mountPath: /host/var/log
            - name: configmap
              mountPath: /etc/netdata/go.d.conf
              subPath: go.d
            - name: configmap
              mountPath: /etc/netdata/go.d/k8s_kubelet.conf
              subPath: kubelet
            - name: configmap
              mountPath: /etc/netdata/go.d/k8s_kubeproxy.conf
              subPath: kubeproxy
            - name: configmap
              mountPath: /etc/netdata/netdata.conf
              subPath: netdata
            - name: configmap
              mountPath: /etc/netdata/stream.conf
              subPath: stream
            - name: persistencevarlibdir
              mountPath: /var/lib/netdata
            - name: sdconfigmap
              mountPath: "/etc/netdata/go.d/sd/k8s.conf"
              subPath: config.yml
          securityContext:
            capabilities:
              add:
                - SYS_PTRACE
                - SYS_ADMIN
          resources:
            {}
      tolerations:
        - effect: NoSchedule
          operator: Exists
      terminationGracePeriodSeconds: 30
      volumes:
        - name: proc
          hostPath:
            path: /proc
        - name: sys
          hostPath:
            path: /sys
        - name: os-release
          hostPath:
            path: /etc/os-release
        - name: varlog
          hostPath:
            path: /var/log
        - name: configmap
          configMap:
            name: netdata-conf-child
            optional: true
        - name: configsecret
          secret:
            secretName: netdata-conf-child
            optional: true
        - name: persistencevarlibdir
          hostPath:
            path: /var/lib/netdata-k8s-child/var/lib/netdata
            type: DirectoryOrCreate
        - name: sdconfigmap
          configMap:
            name: netdata-child-sd-config-map
            optional: true
      dnsPolicy: ClusterFirstWithHostNet
# -----------------------------------------------------------------------------

---
# -----------------------------------------------------------------------------
# Source: ems-server/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ems-server-service-account
  labels:
    helm.sh/chart: ems-server-0.1.0
    app.kubernetes.io/name: ems-server
    app.kubernetes.io/instance: emsserver
    app.kubernetes.io/version: "7.0.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
---
# Source: ems-server/templates/deployment.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ems-server-cluster-role
rules:
  - apiGroups: ["", "apps"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list", "watch"]
---
# Source: ems-server/templates/deployment.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ems-server-cluster-role-binding
subjects:
  - kind: ServiceAccount
    name: ems-server-service-account
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ems-server-cluster-role
---
# Source: ems-server/templates/deployment.yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ems-server-role
rules:
  - apiGroups: ["", "apps"] # Empty string for kubernetes system
    resources: ["configmaps", "daemonsets"]
    resourceNames: ["monitoring-configmap", "ems-client-configmap", "ems-client-daemonset"]
    verbs: ["get", "update", "delete", "list", "watch", "patch"]
  - apiGroups: ["", "apps"] # Empty string for kubernetes system
    resources: ["configmaps", "daemonsets"]
    verbs: ["create"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ems-server-role-binding
subjects:
  - kind: ServiceAccount
    name: ems-server-service-account
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ems-server-role
---
# Source: ems-server/templates/service.yaml
#
# Copyright (C) 2017-2025 Institute of Communication and Computer Systems (imu.iccs.gr)
#
# This Source Code Form is subject to the terms of the Mozilla Public License, v2.0, unless
# Esper library is used, in which case it is subject to the terms of General Public License v2.0.
# If a copy of the MPL was not distributed with this file, you can obtain one at
# https://www.mozilla.org/en-US/MPL/2.0/
#

apiVersion: v1
kind: Service
metadata:
  name: emsserver-ems-server
  labels:
    helm.sh/chart: ems-server-0.1.0
    app.kubernetes.io/name: ems-server
    app.kubernetes.io/instance: emsserver
    app.kubernetes.io/version: "7.0.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8111
      targetPort: http
      protocol: TCP
      name: http
    - port: 61616
      targetPort: 61616
      protocol: TCP
      name: openwire
    - port: 61610
      targetPort: 61610
      protocol: TCP
      name: stomp2
  selector:
    app.kubernetes.io/name: ems-server
    app.kubernetes.io/instance: emsserver
---
# ConfigMap with the TOSCA acquisition script

apiVersion: v1
kind: ConfigMap
metadata:
  name: tosca-script-config
data:
  get-tosca-model.sh: |
    #!/bin/sh

    # Install curl and jq once; exit if it fails
    apk add --no-cache curl jq || {
      echo "Failed to install curl and jq, exiting."
      exit 1
    }

    is_empty() {
      # returns 0 (true) if input is empty or only whitespace
      [ -z "$(echo "$1" | tr -d '[:space:]')" ]
    }


    OPTIMUSDB_URL=http://optimusdb-headless:8089/swarmkb
    TOSCA_MODEL_FILE=tosca-model.yaml
    TOSCA_MODEL_PATH=/shared/tosca-model.yaml
    RETRY_DELAY=5

    while [ ! -f "$TOSCA_MODEL_PATH" ]; do
      resp_1=$(curl -s -X POST $OPTIMUSDB_URL/command \
        -H "Content-Type: application/json" \
        -d "{\"method\": {\"cmd\": \"sqldml\",\"argcnt\": 1},\"sqldml\": \"\nSELECT id, template_id,filename, filesize_bytes, content_sha256, ipfs_path,\n       uploader, source_pod, source_ip, description, node_templates_count, created_at\nFROM toscametadata\nWHERE filename='$TOSCA_MODEL_FILE'\nORDER BY id DESC\nLIMIT 1;\n\"}")
      echo "Response-1: $resp_1"

      TEMPLATE_ID=$(echo $resp_1 | jq -r '.data.records[0].template_id // ""')
      if is_empty "$TEMPLATE_ID"; then
        echo "TEMPLATE_ID is empty or whitespace, retrying in $RETRY_DELAY seconds..."
        sleep $RETRY_DELAY
        continue
      fi

      echo "TEMPLATE_ID: $TEMPLATE_ID"

      resp_2=$( curl -s -X POST $OPTIMUSDB_URL/command \
        -H "Content-Type: application/json" \
        -d "{ \"method\": {\"cmd\": \"crudget\", \"argcnt\": 1}, \"dstype\": \"tosca_imported\", \"criteria\": [{\"_id\": \"$TEMPLATE_ID\"}] }" )
      echo "Response-2: $resp_2"

      echo "$resp_2" |jq -r '.data[0].yaml // ""'  >  $TOSCA_MODEL_PATH
      if [ ! -s "$TOSCA_MODEL_PATH" ] || is_empty "$(cat $TOSCA_MODEL_PATH)"; then
        echo "$TOSCA_MODEL_PATH is empty or whitespace, retrying in $RETRY_DELAY seconds..."
        sleep $RETRY_DELAY
        continue
      fi

      cat $TOSCA_MODEL_PATH
      break
    done

    echo "Done"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tosca-model-configmap
data:
  tosca-model.yaml: |
    tosca_definitions_version: tosca_prestocloud_mapping_1_2
    
    metadata:
       template_name: ICCS generated types definition
       template_author: ICCS
    
    description: Types Description
    
    imports:
       - tosca-normative-types:1.2
       - iccs-normative-types:1.0
       - resource-descriptions:1.0
       - placement-constraints:1.0
    
    node_types:
      a_component:
        nodes.AdvancedMonitoringCollector: 
          derived_from: tosca.nodes.Root 
          description: An example illustrating metric collection possibilities 
          capabilities: 
            - monitoring: 
                type: capabilities.MetricMonitoringCapability 
                properties:
                  raw:
                    - cpu_util_instance: 
                        collector: netdata
    #                    collector_inst: netdata__system__cpu__user
                        config:
                          scope_contexts: system.cpu
                          results-aggregation: SUM
                        collection_frequency: 15 s
                        collection_output: all  #first/last
                        unit: 
                          id: 'prct'
                          type: real
                          range: [0, 100] 
                    - response_time:
                        collector: prometheus
                        collector_inst: request_processing_seconds_sum
                        config:
                          metric: 'request_processing_seconds_sum'
                          port: 9000
                          endpoint: /
                          delay: 0
                          components: 'app'
                          namespace: 'default'
                        collection_frequency: 30 s
                        collection_output: all
                        unit:
                          id: 's'
                          type: real
    
                  composite:
                    - mean_cpu_util_prct:
                        formula: 
                          type: 'mean'
                          argument: 'cpu_util_instance'
                          collection_frequency: 30 s
                          collection_output: all  #first/last
                        window: 
                          type: 'sliding'  
                          size: '5 min'
    #                    processing:
    #                      type: 'grouping'  #fasdsd
    #                      criteria: 'PER_ZONE' #PER_HOST/PER_ZONE/PER_REGION/CROSS-SWARMS
                          
                    - mean_response_time:
                        formula:
                          type: 'mean'
                          argument: 'response_time'
                          collection_frequency: 30 s
                          collection_output: all  #first/last
                        window:
                          type: 'sliding'
                          size: '5 min'
    #                    processing:
    #                      type: 'grouping'  #fasdsd
    #                      criteria: 'PER_ZONE' #PER_HOST/PER_ZONE/PER_REGION/CROSS-SWARMS
    
            - slo:
                type: capabilities.SloMonitoringCapability 
                properties: 
                  - cpu_slo: 
                      constraint: 'mean_cpu_util_prct > 80'
                  - response_time_slo:
                      constraint: 'mean_response_time > 500'
---
# Source: ems-server/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emsserver-ems-server
  labels:
    helm.sh/chart: ems-server-0.1.0
    app.kubernetes.io/name: ems-server
    app.kubernetes.io/instance: emsserver
    app.kubernetes.io/version: "7.0.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ems-server
      app.kubernetes.io/instance: emsserver
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ems-server
        app.kubernetes.io/instance: emsserver
    spec:

      serviceAccountName: ems-server-service-account
      securityContext:
        {}
      
      volumes:
        - name: shared-data
          emptyDir: {}
        - name: script-volume
          configMap:
            name: tosca-script-config
            defaultMode: 0755    # Make script executable
        - name: tosca-model-data
          configMap:
            name: tosca-model-configmap
      
      initContainers:
        - name: init-tosca-model-writer
          image: alpine:latest
          command: ["sh", "-c", "/scripts/get-tosca-model.sh | tee /shared/get-tosca-model.log"]
          volumeMounts:
            - name: shared-data
              mountPath: /shared
            - name: script-volume
              mountPath: /scripts/get-tosca-model.sh
              subPath: get-tosca-model.sh
              # Mount read-only
              readOnly: true
      
      terminationGracePeriodSeconds: 10
      containers:
        - name: ems-server
          securityContext:
            {}
          image: "docker.io/ipatini/emsserver:latest"
          #imagePullPolicy: IfNotPresent
          imagePullPolicy: Always
          volumeMounts:
            - name: shared-data
              mountPath: /opt/ems-server/models
#            - name: tosca-model-data
#              mountPath: /opt/ems-server/models/tosca-model.yaml
#              subPath: tosca-model.yaml
#              readOnly: true
            - name: script-volume
              mountPath: /scripts/get-tosca-model.sh
              subPath: get-tosca-model.sh
              # Mount read-only
              readOnly: true

          env:
            #
            # EMS server configuration -- Environment variables from command line
            #
            - name: APPLICATION_ID
              value: ""
            - name: EXTERNAL_BROKER_ADDRESS
              value: ""
            - name: EXTERNAL_BROKER_PORT
              value: "5672"
            - name: EXTERNAL_BROKER_USERNAME
              value: ""
            - name: EXTERNAL_BROKER_PASSWORD
              value: ""
            #
            # EMS server configuration -- Environment variables from values.yaml
            #
            - name: JASYPT_PASSWORD
              value: "password"
            - name: NET_UTIL_ADDRESS_DISCOVERY_SERVICES
              value: "-"
            - name: EMS_IP_SETTING
              value: "DEFAULT_IP"
            - name: K8S_WATCHER_ENABLED
              value: "true"
            - name: EMS_LOG_REQUESTS
              value: "false"
            - name: EMS_PRELOAD_APP_MODEL
              value: "tosca-model.yaml"
            - name: CONTROL_SKIP_METASOLVER
              value: "true"
            - name: CONTROL_SKIP_NOTIFICATION
              value: "true"
            - name: CONTROL_EXIT_ALLOWED
              value: "true"
            - name: RESTART_EXIT_CODE
              value: "99"
            - name: BEACON_ENABLED
              value: "false"
            - name: BOOT_ENABLED
              value: "false"
            - name: BOOT_INITIALIZER_ENABLED
              value: "true"
            - name: K8S_DEPLOY_EMS_CLIENTS_ON_KUBERNETES_ENABLED
              value: "true"
            - name: EXTERNAL_ENABLED
              value: "false"
            - name: BROKERCEP_AUTHENTICATION_ENABLED
              value: 'false'
            - name: BROKERCEP_EVENT_RECORDER_ENABLED
              value: "false"
            - name: BROKERCEP_EVENT_RECORDER_FILTER_MODE
              value: "ALL"
            - name: EMS_CLIENT_DEPLOYMENT_DRY_RUN
              value: "false"
            - name: K8S_SERVICE_ACCOUNT_SECRETS_PATH
              value: "/var/run/secrets/kubernetes.io/serviceaccount"
            - name: APP_CONFIG_MAP_NAME
              value: "monitoring-configmap"
            - name: EMS_CLIENT_CONFIG_MAP_NAME
              value: "ems-client-configmap"
            - name: EMS_CLIENT_DAEMONSET_NAME
              value: "ems-client-daemonset"
            - name: EMS_CLIENT_DAEMONSET_IMAGE_REPOSITORY
              value: "docker.io/ipatini/emsclient"
            - name: EMS_CLIENT_DAEMONSET_IMAGE_TAG
              value: "latest"
            - name: EMS_CLIENT_DAEMONSET_IMAGE_PULL_POLICY
              value: "Always"
            - name: EMS_CLIENT_ENV_BROKERCEP_AUTHENTICATION_ENABLED
              value: 'false'
            - name: EMS_CLIENT_KEYSTORE_SECRET
              value: ""
            - name: EMS_CLIENT_TRUSTSTORE_SECRET
              value: ""
            #
            # K8S cluster node info
            #
            - name: EMS_SERVER_K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: EMS_SERVER_K8S_NODE_ADDRESS
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            #
            # EMS server Pod info
            #
            - name: EMS_SERVER_POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: EMS_SERVER_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: EMS_SERVER_POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: EMS_SERVER_POD_ADDRESS
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - name: http
              containerPort: 8111
              protocol: TCP
            - name: openwire
              containerPort: 61616
              protocol: TCP
            - name: openwire-tls
              containerPort: 61617
              protocol: TCP
            - name: stomp
              containerPort: 61610
              protocol: TCP
          livenessProbe:
            tcpSocket:
              port: http
          readinessProbe:
            tcpSocket:
              port: http
          resources:
            {}
